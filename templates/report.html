<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ãƒ¬ãƒãƒ¼ãƒˆ - å›½å®¶è©¦é¨“å¯¾ç­–ãƒ„ãƒ¼ãƒ«</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header>
        <div class="container">
            <h1>ğŸ“Š ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¬ãƒãƒ¼ãƒˆ</h1>
        </div>
    </header>

    <div class="container">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­...</p>
        </div>

        <div id="report-content" style="display: none;">
            <!-- ãƒ¬ãƒãƒ¼ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <button class="btn" onclick="window.location.href='/'">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
            <button class="btn btn-success" id="download-pdf-btn" style="margin-left: 10px;">
                ğŸ“„ PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </button>
            <button class="btn btn-secondary" id="download-markdown-btn" style="margin-left: 10px;">
                Markdownã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const pathParts = window.location.pathname.split('/');
            const sessionId = pathParts[pathParts.length - 1] || urlParams.get('session');
            
            if (!sessionId) {
                alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                window.location.href = '/';
                return;
            }
            
            try {
                const response = await fetch(`/api/sessions/${sessionId}/report`);
                const data = await response.json();
                
                if (data.error) {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                    window.location.href = '/';
                    return;
                }
                
                // Markdownã‚’HTMLã«å¤‰æ›ã—ã¦è¡¨ç¤º
                const markdownContent = data.markdown || '';
                const htmlContent = convertMarkdownToHtml(markdownContent);
                
                document.getElementById('loading').style.display = 'none';
                const reportContent = document.getElementById('report-content');
                reportContent.innerHTML = htmlContent;
                reportContent.style.display = 'block';
                
                // PDFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
                document.getElementById('download-pdf-btn').addEventListener('click', function() {
                    window.location.href = `/api/sessions/${sessionId}/report/pdf`;
                });
                
                // Markdownãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
                document.getElementById('download-markdown-btn').addEventListener('click', function() {
                    const blob = new Blob([markdownContent], { type: 'text/markdown;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `report_${sessionId}.md`;
                    a.click();
                    URL.revokeObjectURL(url);
                });
                
            } catch (error) {
                console.error('Error loading report:', error);
                alert('ãƒ¬ãƒãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                window.location.href = '/';
            }
        });
        
        function convertMarkdownToHtml(markdown) {
            let html = markdown;
            
            // è¦‹å‡ºã—
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
            
            // å¤ªå­—
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // ãƒªã‚¹ãƒˆ
            html = html.replace(/^- (.*$)/gim, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            
            // æ”¹è¡Œ
            html = html.replace(/\n\n/g, '</p><p>');
            html = html.replace(/\n/g, '<br>');
            
            // æ®µè½ã‚¿ã‚°ã§ãƒ©ãƒƒãƒ—
            html = html.split('</h1>').join('</h1><p>');
            html = html.split('</h2>').join('</h2><p>');
            html = html.split('</h3>').join('</h3><p>');
            html = html.split('</ul>').join('</ul><p>');
            html = '<p>' + html + '</p>';
            
            // ä½™åˆ†ãªæ®µè½ã‚¿ã‚°ã‚’å‰Šé™¤
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p>(<h[123]>)/g, '$1');
            html = html.replace(/(<\/h[123]>)<\/p>/g, '$1');
            html = html.replace(/<p>(<ul>)/g, '$1');
            html = html.replace(/(<\/ul>)<\/p>/g, '$1');
            
            // åŒºåˆ‡ã‚Šç·š
            html = html.replace(/^---$/gim, '<hr>');
            
            return html;
        }
    </script>
</body>
</html>

