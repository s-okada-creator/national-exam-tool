<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>å›½å®¶è©¦é¨“å¯¾ç­–ãƒ„ãƒ¼ãƒ«</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v={{ css_version }}">
</head>
<body>
    <header>
        <div class="container">
            <h1>å›½å®¶è©¦é¨“å¯¾ç­–ãƒ„ãƒ¼ãƒ«</h1>
        </div>
    </header>

    <div class="container">
        <div class="card">
            <h2 style="margin-bottom: 20px; color: #667eea;">ãƒ†ã‚¹ãƒˆè¨­å®š</h2>
            
            <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
            <div class="form-group">
                <label>ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</label>
                <div class="mode-selector">
                    <div class="mode-card" data-mode="practice" id="mode-practice">
                        <h2>ğŸ“– å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰</h2>
                        <p>æ­£è§£ãƒ»è§£èª¬ãƒ»ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤ºã—ãªãŒã‚‰å­¦ç¿’</p>
                    </div>
                    <div class="mode-card" data-mode="test" id="mode-test">
                        <h2>ğŸ“ ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰</h2>
                        <p>æœ¬ç•ªå½¢å¼ã§ãƒ†ã‚¹ãƒˆå®Ÿæ–½</p>
                    </div>
                </div>
            </div>

            <!-- è©¦é¨“å›æ•°é¸æŠ -->
            <div class="form-group">
                <label>è©¦é¨“å›æ•°ã‚’é¸æŠã—ã¦ãã ã•ã„</label>
                <div class="checkbox-group" id="exam-numbers-container">
                    <div class="checkbox-item">
                        <input type="checkbox" id="exam-all" checked>
                        <label for="exam-all">å…¨å›</label>
                    </div>
                </div>
            </div>

            <!-- å­¦ç§‘é¸æŠ -->
            <div class="form-group">
                <label>å­¦ç§‘ï¼ˆã‚¸ãƒ£ãƒ³ãƒ«ï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„</label>
                <div class="checkbox-group" id="categories-container">
                    <div class="checkbox-item">
                        <input type="checkbox" id="category-all" checked>
                        <label for="category-all">å…¨å­¦ç§‘</label>
                    </div>
                </div>
            </div>

            <!-- å•é¡Œæ•°é¸æŠ -->
            <div class="form-group">
                <label>å•é¡Œæ•°ï¼ˆã‚¯ã‚¤ãƒƒã‚¯å¾©ç¿’ç”¨ï¼‰</label>
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
                        <button type="button" class="btn-quick-count" data-count="10">10å•</button>
                        <button type="button" class="btn-quick-count" data-count="15">15å•</button>
                        <button type="button" class="btn-quick-count" data-count="20">20å•</button>
                        <button type="button" class="btn-quick-count" data-count="30">30å•</button>
                        <button type="button" class="btn-quick-count" data-count="50">50å•</button>
                        <button type="button" class="btn-quick-count active" data-count="">å…¨å•</button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" id="max-questions-input" min="1" placeholder="ã‚«ã‚¹ã‚¿ãƒ å•é¡Œæ•°" 
                               style="flex: 1; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
                        <span style="color: #666; font-size: 0.9rem;">
                            é¸æŠä¸­ã®å•é¡Œæ•°: <span id="available-questions-count">-</span>å•
                        </span>
                    </div>
                    <div id="question-count-warning" style="margin-top: 10px; display: none;" class="warning"></div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-success" id="start-btn" style="font-size: 1.2rem; padding: 15px 40px;">
                    ãƒ†ã‚¹ãƒˆé–‹å§‹
                </button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/app.js') }}?v={{ js_version }}"></script>
    <script>
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // è©¦é¨“å›æ•°ã‚’å–å¾—
                const examResponse = await fetch('/api/exam-numbers');
                const examData = await examResponse.json();
                const examContainer = document.getElementById('exam-numbers-container');
                
                examData.exam_numbers.forEach(examNum => {
                    const item = document.createElement('div');
                    item.className = 'checkbox-item';
                    item.innerHTML = `
                        <input type="checkbox" id="exam-${examNum}" value="${examNum}">
                        <label for="exam-${examNum}">ç¬¬${examNum}å›</label>
                    `;
                    examContainer.appendChild(item);
                });

                // ã‚¸ãƒ£ãƒ³ãƒ«ã‚’å–å¾—
                const catResponse = await fetch('/api/categories');
                const catData = await catResponse.json();
                const catContainer = document.getElementById('categories-container');
                
                Object.entries(catData.categories).forEach(([category, count]) => {
                    const item = document.createElement('div');
                    item.className = 'checkbox-item';
                    item.innerHTML = `
                        <input type="checkbox" id="cat-${category}" value="${category}">
                        <label for="cat-${category}">${category} (${count}å•)</label>
                    `;
                    catContainer.appendChild(item);
                });

                // ãƒ¢ãƒ¼ãƒ‰é¸æŠ
                let selectedMode = 'practice';
                document.querySelectorAll('.mode-card').forEach(card => {
                    card.addEventListener('click', function() {
                        document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('active'));
                        this.classList.add('active');
                        selectedMode = this.dataset.mode;
                    });
                });
                document.getElementById('mode-practice').classList.add('active');

                // å…¨é¸æŠã®å‡¦ç†
                document.getElementById('exam-all').addEventListener('change', function() {
                    const checkboxes = examContainer.querySelectorAll('input[type="checkbox"]:not(#exam-all)');
                    checkboxes.forEach(cb => cb.checked = this.checked);
                });

                document.getElementById('category-all').addEventListener('change', function() {
                    const checkboxes = catContainer.querySelectorAll('input[type="checkbox"]:not(#category-all)');
                    checkboxes.forEach(cb => cb.checked = this.checked);
                });

                // å€‹åˆ¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´æ™‚ã«å…¨é¸æŠã®çŠ¶æ…‹ã‚’æ›´æ–°
                examContainer.addEventListener('change', function(e) {
                    if (e.target.id !== 'exam-all') {
                        const allChecked = Array.from(examContainer.querySelectorAll('input[type="checkbox"]:not(#exam-all)'))
                            .every(cb => cb.checked);
                        document.getElementById('exam-all').checked = allChecked;
                    }
                });

                catContainer.addEventListener('change', function(e) {
                    if (e.target.id !== 'category-all') {
                        const allChecked = Array.from(catContainer.querySelectorAll('input[type="checkbox"]:not(#category-all)'))
                            .every(cb => cb.checked);
                        document.getElementById('category-all').checked = allChecked;
                    }
                });

                // å•é¡Œæ•°é¸æŠã®æ›´æ–°é–¢æ•°
                function updateAvailableQuestionsCount() {
                    const examNumbers = Array.from(examContainer.querySelectorAll('input[type="checkbox"]:checked:not(#exam-all)'))
                        .map(cb => parseInt(cb.value));
                    const categories = Array.from(catContainer.querySelectorAll('input[type="checkbox"]:checked:not(#category-all)'))
                        .map(cb => cb.value);

                    // APIã‚’å‘¼ã³å‡ºã—ã¦é¸æŠã•ã‚ŒãŸå•é¡Œæ•°ã‚’å–å¾—
                    const params = new URLSearchParams();
                    if (examNumbers.length > 0) {
                        examNumbers.forEach(num => params.append('exam_numbers', num));
                    }
                    if (categories.length > 0) {
                        categories.forEach(cat => params.append('categories', cat));
                    }

                    fetch(`/api/questions?${params.toString()}`)
                        .then(response => response.json())
                        .then(data => {
                            const count = data.total || 0;
                            document.getElementById('available-questions-count').textContent = count;
                            checkQuestionCountWarning();
                        })
                        .catch(error => {
                            console.error('Error fetching question count:', error);
                        });
                }

                // å•é¡Œæ•°è­¦å‘Šã®ãƒã‚§ãƒƒã‚¯
                function checkQuestionCountWarning() {
                    const warningDiv = document.getElementById('question-count-warning');
                    const input = document.getElementById('max-questions-input');
                    const maxQuestions = parseInt(input.value) || null;
                    const available = parseInt(document.getElementById('available-questions-count').textContent) || 0;

                    if (maxQuestions && maxQuestions > available) {
                        warningDiv.textContent = `è­¦å‘Š: é¸æŠã•ã‚ŒãŸå•é¡Œæ•°ï¼ˆ${available}å•ï¼‰ã‚ˆã‚Šå¤šã„å•é¡Œæ•°ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚å…¨å•ï¼ˆ${available}å•ï¼‰ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚`;
                        warningDiv.style.display = 'block';
                    } else {
                        warningDiv.style.display = 'none';
                    }
                }

                // ã‚¯ã‚¤ãƒƒã‚¯é¸æŠãƒœã‚¿ãƒ³
                document.querySelectorAll('.btn-quick-count').forEach(btn => {
                    btn.addEventListener('click', function() {
                        document.querySelectorAll('.btn-quick-count').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        const count = this.dataset.count;
                        const input = document.getElementById('max-questions-input');
                        if (count === '') {
                            input.value = '';
                        } else {
                            input.value = count;
                        }
                        checkQuestionCountWarning();
                    });
                });

                // å•é¡Œæ•°å…¥åŠ›ã®å¤‰æ›´
                document.getElementById('max-questions-input').addEventListener('input', function() {
                    // ã‚¯ã‚¤ãƒƒã‚¯é¸æŠãƒœã‚¿ãƒ³ã®activeã‚’è§£é™¤
                    document.querySelectorAll('.btn-quick-count').forEach(b => b.classList.remove('active'));
                    checkQuestionCountWarning();
                });

                // è©¦é¨“å›æ•°ãƒ»ã‚¸ãƒ£ãƒ³ãƒ«ã®å¤‰æ›´æ™‚ã«å•é¡Œæ•°ã‚’æ›´æ–°
                examContainer.addEventListener('change', function() {
                    updateAvailableQuestionsCount();
                });

                catContainer.addEventListener('change', function() {
                    updateAvailableQuestionsCount();
                });

                // åˆå›ã®å•é¡Œæ•°ã‚’å–å¾—
                updateAvailableQuestionsCount();

                // ãƒ†ã‚¹ãƒˆé–‹å§‹ãƒœã‚¿ãƒ³
                document.getElementById('start-btn').addEventListener('click', async function() {
                    const examNumbers = Array.from(examContainer.querySelectorAll('input[type="checkbox"]:checked:not(#exam-all)'))
                        .map(cb => parseInt(cb.value));
                    const categories = Array.from(catContainer.querySelectorAll('input[type="checkbox"]:checked:not(#category-all)'))
                        .map(cb => cb.value);
                    
                    const maxQuestionsInput = document.getElementById('max-questions-input');
                    const maxQuestions = maxQuestionsInput.value ? parseInt(maxQuestionsInput.value) : null;

                    try {
                        const response = await fetch('/api/sessions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                mode: selectedMode,
                                exam_numbers: examNumbers.length > 0 ? examNumbers : null,
                                categories: categories.length > 0 ? categories : null,
                                max_questions: maxQuestions
                            })
                        });

                        const data = await response.json();
                        if (data.session_id) {
                            if (selectedMode === 'practice') {
                                window.location.href = `/practice?session=${data.session_id}`;
                            } else {
                                window.location.href = `/test?session=${data.session_id}`;
                            }
                        }
                    } catch (error) {
                        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                    }
                });

            } catch (error) {
                console.error('Error loading data:', error);
                alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        });
    </script>
</body>
</html>

