# 国家試験対策ツール - アーキテクチャドキュメント

## システム概要

あん摩マッサージ指圧師国家試験の対策用Webアプリケーションです。Flaskベースのバックエンドと、バニラJavaScriptによるフロントエンドで構成されています。

## アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────┐
│                        クライアント（ブラウザ）                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  index.html  │  │ practice.html │  │  test.html   │         │
│  │  (トップ)    │  │  (学習モード) │  │ (テストモード)│         │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘         │
│         │                 │                  │                  │
│         └─────────────────┴──────────────────┘                  │
│                            │                                     │
│                   ┌────────▼────────┐                            │
│                   │   app.js        │                            │
│                   │ (フロントエンド) │                            │
│                   └────────┬────────┘                            │
└────────────────────────────┼────────────────────────────────────┘
                             │ HTTP/REST API
┌────────────────────────────▼────────────────────────────────────┐
│                    Vercel サーバーレス関数                        │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              api/index.py (Vercelエントリーポイント)        │  │
│  │                    ↓ (Flaskアプリをエクスポート)            │  │
│  └──────────────────────────────────────────────────────────┘  │
│                            │                                     │
│  ┌─────────────────────────▼─────────────────────────────────┐  │
│  │                  Flask アプリケーション                      │  │
│  │  ┌──────────────────────────────────────────────────────┐ │  │
│  │  │              app.py (メインアプリ)                      │ │  │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────┐  │ │  │
│  │  │  │  ルーティング  │  │ セッション管理 │  │環境検出   │  │ │  │
│  │  │  └──────┬───────┘  └──────┬───────┘  └──────┬─────┘  │ │  │
│  │  └────────┼──────────────────┼──────────────────┼────────┘ │  │
│           │                  │                  │               │
│  ┌────────▼──────────────────▼──────────────────▼───────────┐  │
│  │                    API エンドポイント                      │  │
│  │  • /api/categories          (ジャンル一覧)                │  │
│  │  • /api/exam-numbers        (試験回数一覧)                │  │
│  │  • /api/questions            (問題一覧・フィルタ)           │  │
│  │  • /api/questions/<id>      (特定の問題)                   │  │
│  │  • /api/sessions            (セッション作成)               │  │
│  │  • /api/sessions/<id>       (セッション取得)               │  │
│  │  • /api/sessions/<id>/answers (解答送信)                   │  │
│  │  • /api/sessions/<id>/report (レポート生成)                │  │
│  │  • /api/sessions/<id>/report/pdf (PDFレポート)             │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
┌───────▼────────┐  ┌────────▼────────┐  ┌───────▼────────┐
│ QuestionManager│  │ ReportGenerator │  │  Session Store │
│  (問題管理)     │  │  (レポート生成)  │  │  (メモリ保存)   │
└───────┬────────┘  └─────────────────┘  └────────────────┘
        │
┌───────▼──────────────────────────────────────────────────────┐
│                    データレイヤー                              │
│  ┌──────────────────┐  ┌──────────────────┐                  │
│  │ questions.json   │  │ セッション保存    │                  │
│  │ (問題データ)      │  │                  │                  │
│  │ 読み取り専用     │  │ ローカル: data/   │                  │
│  │                  │  │ Vercel: /tmp/    │                  │
│  └──────────────────┘  └──────────────────┘                  │
│                                                               │
│  注意: Vercel環境ではメモリ上のセッションデータが主要         │
└───────────────────────────────────────────────────────────────┘
```

## コンポーネント詳細

### 1. フロントエンド層

#### 1.1 HTMLテンプレート (`templates/`)
- **index.html**: トップページ（モード選択・フィルタ設定）
- **practice.html**: 学習モード画面
- **test.html**: テストモード画面
- **report.html**: レポート表示画面
- **error.html**: エラーページ

#### 1.2 JavaScript (`static/js/app.js`)
- **セッション管理**: セッションIDに基づく状態管理
- **問題表示**: 問題文・選択肢のレンダリング
- **解答処理**: 選択肢のクリック処理と解答送信
- **ナビゲーション**: 前/次問題への移動、プログレスバー更新
- **タイマー**: テストモードでの解答時間計測

#### 1.3 CSS (`static/css/style.css`)
- レスポンシブデザイン
- モダンなUIスタイル

### 2. バックエンド層

#### 2.1 メインアプリケーション (`app.py`)
- **Flaskアプリケーション**: ルーティングとリクエスト処理
- **セッション管理**: メモリベースのセッションストア（本番環境ではDB推奨）
- **エラーハンドリング**: 問題データ読み込み失敗時の処理

#### 2.2 APIエンドポイント

##### データ取得系
- `GET /api/categories`: 全ジャンルと問題数を取得
- `GET /api/exam-numbers`: 全試験回数のリストを取得
- `GET /api/questions`: 問題一覧を取得（フィルタリング対応）
- `GET /api/questions/<question_id>`: 特定の問題を取得

##### セッション管理系
- `POST /api/sessions`: 新しいセッションを作成
- `GET /api/sessions/<session_id>`: セッション情報を取得
- `POST /api/sessions/<session_id>/answers`: 解答を送信

##### レポート生成系
- `GET /api/sessions/<session_id>/report`: Markdown/JSONレポートを生成
- `GET /api/sessions/<session_id>/report/pdf`: PDFレポートをダウンロード

### 3. ビジネスロジック層

#### 3.1 QuestionManager (`utils/question_manager.py`)
- **問題データ管理**: JSONファイルからの問題データ読み込み
- **フィルタリング**: 試験回数・ジャンルによる問題フィルタリング
- **サンプリング**: ランダムサンプリング機能（最大問題数制限対応）
- **統計情報**: ジャンル別問題数、試験回数リストの取得

#### 3.2 ReportGenerator (`utils/report_generator.py`)
- **Markdownレポート**: Notebook.lm対応のMarkdown形式レポート生成
- **JSONレポート**: API用のJSON形式レポート生成
- **PDFレポート**: ReportLabを使用したPDF形式レポート生成
- **統計計算**: 正答率、ジャンル別成績の計算

### 4. データ処理層

#### 4.1 ExcelLoader (`utils/excel_loader.py`)
- **Excel読み込み**: openpyxlを使用したExcelファイルからの問題データ抽出
- **データマージ**: ExcelデータとPDFデータの統合
- **JSON出力**: 問題データをJSON形式で保存

#### 4.2 PDFLoader (`utils/pdf_loader.py`)
- **PDF抽出**: pdfplumberを使用したPDFファイルからの問題文・選択肢抽出
- **テキストパース**: 正規表現による問題番号・選択肢の抽出
- **複数ファイル対応**: 前半・後半PDFの統合処理

### 5. データストレージ

#### 5.1 問題データ (`data/questions.json`)
```json
[
  {
    "id": "29_1",
    "exam_number": 29,
    "question_number": 1,
    "category": "あん摩マッサージ指圧理論",
    "theme": "あん摩の定義",
    "question_text": "問題文...",
    "choices": {
      "1": "選択肢1",
      "2": "選択肢2",
      "3": "選択肢3",
      "4": "選択肢4"
    },
    "correct_answer": [1],
    "explanation": "解説文...",
    "hint": "ヒント..."
  }
]
```

#### 5.2 セッションデータ
- **ローカル環境**: `data/sessions/` - セッションIDをファイル名としたJSONファイル
- **Vercel環境**: `/tmp/sessions/` - 一時的なストレージ（関数実行後に削除される可能性あり）
- **内容**: 解答履歴、問題データ、統計情報を含む
- **注意**: Vercel環境ではメモリ上のセッションデータが主要な保存場所

## データフロー

### セッション作成フロー
```
1. ユーザーがトップページでモード・フィルタを選択
2. フロントエンド: POST /api/sessions にリクエスト
3. バックエンド: QuestionManagerで問題をフィルタリング
4. バックエンド: セッションIDを生成し、メモリに保存
5. フロントエンド: セッションIDを受け取り、問題画面に遷移
```

### 解答送信フロー
```
1. ユーザーが選択肢をクリック
2. フロントエンド: 解答データをPOST /api/sessions/<id>/answers に送信
3. バックエンド: セッションデータに解答を追加
4. フロントエンド: ローカルのanswers配列も更新
```

### レポート生成フロー
```
1. ユーザーがテスト終了ボタンをクリック
2. フロントエンド: GET /api/sessions/<id>/report にリクエスト
3. バックエンド: ReportGeneratorで統計を計算
4. バックエンド: Markdown/JSON/PDFレポートを生成
5. フロントエンド: レポート画面に表示
```

## デプロイメント

### Vercel（サーバーレス）⭐ 推奨

#### アーキテクチャの特徴
- **エントリーポイント**: `api/index.py` - Flaskアプリを直接エクスポート
- **設定ファイル**: `vercel.json` - ルーティングと関数設定
- **ビルド**: Vercelが自動的にPython環境を構築
- **制限**: 最大実行時間30秒、メモリ1024MB

#### Vercel環境での最適化
1. **環境検出**: `VERCEL`環境変数でVercel環境を自動検出
2. **パス解決**: プロジェクトルートからの絶対パスを使用
3. **静的ファイル**: `static/`ディレクトリは自動的に配信
4. **テンプレート**: `templates/`ディレクトリは絶対パスで指定
5. **セッション保存**: `/tmp/sessions/`に保存（一時的、関数実行後に削除される可能性あり）
6. **データファイル**: `data/questions.json`はリポジトリに含まれ、読み取り専用で使用

#### セッション管理の制約
- Vercelのサーバーレス環境では、セッションデータはメモリ上に保存
- 関数が再起動されるとセッションデータは消去される
- 永続化が必要な場合は外部ストレージ（Vercel KV、データベース等）の使用を推奨

### Render（従来型サーバー）
- **設定ファイル**: `render.yaml`
- **起動コマンド**: `python app.py`
- **Procfile**: 本番環境用の設定
- **セッション保存**: `data/sessions/`に永続保存可能

## 技術スタック

### バックエンド
- **Flask 3.0.0**: Webフレームワーク
- **pandas 2.1.4**: データ処理（将来の拡張用）
- **openpyxl 3.1.2**: Excelファイル読み込み
- **pdfplumber 0.10.3**: PDFファイル解析
- **reportlab 4.0.7**: PDFレポート生成

### フロントエンド
- **バニラJavaScript**: フレームワークなし
- **HTML5/CSS3**: モダンなUI

### インフラ
- **Vercel**: サーバーレスデプロイメント（推奨）
- **Render**: 従来型サーバーデプロイメント

## セキュリティ考慮事項

1. **セッション管理**: 
   - 現在はメモリベース（Vercel環境では関数再起動で消去される可能性）
   - 本番環境ではDBまたはRedis推奨
   - Vercel KV（Key-Value Store）の使用も検討可能
2. **シークレットキー**: 環境変数から取得（`SECRET_KEY`）
3. **CORS**: 必要に応じて設定
4. **入力検証**: APIエンドポイントでのパラメータ検証
5. **ファイルシステム**: Vercel環境では`/tmp`のみ書き込み可能

## Vercel環境での制約と対応

### 制約事項
1. **ファイルシステム**: 読み取り専用（`/tmp`のみ書き込み可能）
2. **セッション永続化**: メモリベースのため、関数再起動で消去される可能性
3. **実行時間**: 最大30秒（無料プランでは10秒）
4. **メモリ**: 最大1024MB

### 対応策
1. **セッション管理**: 
   - 現在: メモリベース（一時的）
   - 推奨: Vercel KV、Upstash Redis、または外部データベース
2. **データ保存**: 
   - 問題データ: リポジトリに含める（読み取り専用）
   - セッションデータ: 外部ストレージを使用
3. **パフォーマンス**: 
   - 問題データの事前読み込み
   - キャッシュの活用

## 今後の拡張可能性

1. **データベース統合**: 
   - Vercel Postgres、PlanetScale、またはSupabase
   - セッションとユーザーデータの永続化
2. **ユーザー認証**: 
   - Vercel Auth、NextAuth.js、またはAuth0
   - ログイン機能の追加
3. **進捗追跡**: 
   - ユーザーごとの学習履歴管理
   - データベースに保存
4. **問題追加機能**: 
   - 管理画面からの問題追加
   - データベースへの直接書き込み
5. **統計ダッシュボード**: 
   - 詳細な分析機能
   - リアルタイム統計
6. **モバイルアプリ**: 
   - React Native等でのモバイル対応
   - APIを共有

